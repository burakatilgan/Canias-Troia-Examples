-- MAILHTMLGENERAL --

PARAMETERS: 
 STRING PCOMPANY,
 STRING PLANGU,
 STRING PMAINDOCTYPE,
 STRING PMAINDOCNUM,
 STRING PTABLEHEADDOCTYPE,
 STRING PTABLEHEADDOCNUM,
 STRING PTABLEROWDOCTYPE,
 STRING PTABLEROWDOCNUM,
 STRING PHEAD,
 STRING PMESSAGE,
 STRING PVIRTUALTABLE,
 STRING PTABLEHEAD,
 STRING PTABLEROW,
 STRING PDELIMITER;

OBJECT: 
 DOC003 DOC003REC,
 STRING MAINLTEXT,
 STRING TABLEHEADLTEXT,
 STRING PTABLEHEADER,
 STRING TABLEROWLTEXT,
 STRING PTABLEROWS,
 STRING PARSESTR;

DOC003REC.FETCH(PCOMPANY,PLANGU,PMAINDOCTYPE,PMAINDOCNUM);
MOVE IASDOC003_LTEXT TO MAINLTEXT;
DOC003REC.FETCH(PCOMPANY,PLANGU,PTABLEHEADDOCTYPE,PTABLEHEADDOCNUM);
MOVE IASDOC003_LTEXT TO TABLEHEADLTEXT;
DOC003REC.FETCH(PCOMPANY,PLANGU,PTABLEROWDOCTYPE,PTABLEROWDOCNUM);
MOVE IASDOC003_LTEXT TO TABLEROWLTEXT;
COPY STRUCTURE PVIRTUALTABLE INTO VIRTUALTBLSTRUCT;
OBJECT: 
 STRING STRVAL;


IF PTABLEHEAD != '' THEN
	PTABLEHEADER = '';

	PARSE PTABLEHEAD INTO PARSESTR DELIMITER @PDELIMITER 
	BEGIN
		PTABLEHEADER = PTABLEHEADER + REPLACE(TABLEHEADLTEXT,'#TABLEHEAD#',PARSESTR);
	ENDPARSE;

ENDIF;


IF PTABLEROW != '' 
		&& PVIRTUALTABLE !='' THEN
	PTABLEROWS = '';

	LOOP AT PVIRTUALTABLE 
	BEGIN

		IF PTABLEROWS != '' THEN
			PTABLEROWS = PTABLEROWS + '</tr><tr>';
		ENDIF;


		PARSE PTABLEROW INTO PARSESTR DELIMITER @PDELIMITER 
		BEGIN
			LOCATERECORD SEQUENTIAL COLUMNS COLNAME VALUES PARSESTR ON VIRTUALTBLSTRUCT;
			PARSESTR = PVIRTUALTABLE + '_' + PARSESTR;

			IF !SYS_STATUS THEN

				SWITCH VIRTUALTBLSTRUCT_COLTYPE 
				CASE 'DATE':
					STRVAL =  FORMATDATE(@PARSESTR, 'dd.MM.yyyy');
				CASE 'DATETIME':

					IF GETTIME(@PARSESTR)=='00:00' THEN
						STRVAL =  FORMATDATE(@PARSESTR, 'dd.MM.yyyy');
					ELSE
						STRVAL=@PARSESTR;
					ENDIF;

				CASE 'DECIMAL':
					STRVAL = NUMPICTFORMAT(@PARSESTR,'-FL*#,###,##0.00');
				CASE 'INTEGER':
					STRVAL = NUMPICTFORMAT(@PARSESTR,'L0###');
				DEFAULT:
					STRVAL=@PARSESTR;
				ENDSWITCH;

			ELSE
				STRVAL=@PARSESTR;
			ENDIF;

			PTABLEROWS = PTABLEROWS + REPLACE(TABLEROWLTEXT,'#TABLEROW#',STRVAL);
		ENDPARSE;

	ENDLOOP;

ENDIF;

MAINLTEXT = REPLACE(MAINLTEXT,'#HEAD#',PHEAD);
MAINLTEXT = REPLACE(MAINLTEXT,'#MESSAGE#',PMESSAGE);
MAINLTEXT = REPLACE(MAINLTEXT,'#TABLEHEADER#',PTABLEHEADER);
MAINLTEXT = REPLACE(MAINLTEXT,'#TABLEROWS#',PTABLEROWS);
RETURN MAINLTEXT;

-- SEND MAIL --

PARAMETERS: 
 STRING STRMSG,
 STRING STRSUB,
 STRING STRTO,
 STRING STRCC,
 STRING ATTCH;

OBJECT: 
 STRING STRFR,
 STRING STRH,
 STRING STRU,
 STRING STRP,
 STRING STRENC;

/*************/
/**/
STRFR = 'XXX@xxx.com.tr' ;
STRH = 'smtp.XXX.com.tr:PORTNO' ;
STRU = 'info@xxx.com.tr' ;
STRP = 'PASSWORD!' ;
STRENC = 'SSL' ;

IF TRIM(ATTCH) != '' THEN
	SENDMAIL MESSAGE STRMSG TOADDRESS STRTO CCADDRESS STRCC ATTACH ATTCH FROM STRFR SUBJECT STRSUB TYPE HTML HOST STRH USERNAME STRU PASSW STRP ENCPRO STRENC  ;
ELSE
	SENDMAIL MESSAGE STRMSG TOADDRESS STRTO CCADDRESS STRCC FROM STRFR SUBJECT STRSUB TYPE HTML HOST STRH USERNAME STRU PASSW STRP ENCPRO STRENC  ;
ENDIF;


-- MAIL İÇERİK ÖRNEK --

/*BATILGAN 19.12.2022 MÜŞTERİLERDEN ALINACAK ÖDEMELERİN E-MAIL GÖNDERİMİ BAŞLA*/
OBJECT: 
 INTEGER FDAY,
 INTEGER SS;

TRACEON;
FDAY = GETDAYOFWEEK (SYS_CURRENTDATE);

IF SYS_USER=='BATCHMAILUSER' THEN

	IF FDAY == 5 THEN
		OBJECT: 
 USERS TMPUSERS,
		 XXXUTILITY XXXUTILREC,
		 STRING MLTO,
		 STRING MLCC,
		 STRING HTMLMSG,
		 STRING HTMLSUB,
		 DATE DT,
		 DATE DT2;

		DT = ADDDAYS (SYS_CURRENTDATE, 3);
		DT2 = ADDDAYS (DT, 6);
		SELECT IASFINITEM.CURRENCY, IASFINITEM.FINDOCTYPE, IASFINITEM.CUSTOMER, IASACCOUNTX.STEXT AS ATEXT,
			 SUM(IASFINITEM.DPOSTAMNT) AS HPOSTAMNT, SUM(IASFINITEM.DBALANCE) AS HBALANCE 
			FROM IASACCOUNTX , IASFINHEAD , IASFINITEM 
			LEFT OUTER JOIN IASBAS015X ON IASBAS015X.CLIENT = IASFINITEM.CLIENT 
				AND IASBAS015X.COMPANY = IASFINITEM.COMPANY 
				AND IASBAS015X.LANGU = 'T' 
				AND IASBAS015X.PAYMTYPE = IASFINITEM.PAYMTYPE 
			LEFT OUTER JOIN IASBAS016X ON IASBAS016X.CLIENT = IASFINITEM.CLIENT 
				AND IASBAS016X.COMPANY = IASFINITEM.COMPANY 
				AND IASBAS016X.LANGU = 'T' 
				AND IASBAS016X.PAYMCOND = IASFINITEM.PAYMCOND 
			WHERE IASFINITEM.CLIENT = SYS_CLIENT 
				AND IASFINITEM.COMPANY = '02' 
				AND IASFINITEM.FINDOCTYPE LIKE '%' 
				AND IASFINITEM.FINDOCNUM LIKE '%' 
				AND IASFINITEM.CURRENCY LIKE '%' 
				AND IASFINITEM.BUSAREA LIKE '%' 
				AND IASFINITEM.SALINVTYPE LIKE '%' 
				AND IASFINITEM.SALINVNUM LIKE '%' 
				AND IASFINITEM.SALORDTYPE LIKE '%' 
				AND IASFINITEM.SALORDNUM LIKE '%' 
				AND IASFINITEM.PURINVTYPE LIKE '%' 
				AND IASFINITEM.PURINVNUM LIKE '%' 
				AND IASFINITEM.PURORDTYPE LIKE '%' 
				AND IASFINITEM.PURORDNUM LIKE '%' 
				AND IASFINITEM.DUEDATE >= DT 
				AND IASFINITEM.DUEDATE <= DT2 
				AND IASFINITEM.CLOSINGDATE > DT 
				AND IASFINITEM.ACCTYPE = 'C' 
				AND IASFINITEM.POSTSTAT LIKE '%' 
				AND IASFINITEM.DUNKEY LIKE '%' 
				AND IASACCOUNTX.CLIENT = IASFINITEM.CLIENT 
				AND IASACCOUNTX.COMPANY = IASFINITEM.COMPANY 
				AND (IASACCOUNTX.ACCSTD = 0 
				OR IASACCOUNTX.ACCSTD = IASFINITEM.ACCSTD) 
				AND IASACCOUNTX.ACCTYPE = IASFINITEM.ACCTYPE 
				AND IASACCOUNTX.ACCOUNT = IASFINITEM.ACCOUNT 
				AND IASACCOUNTX.LANGU = 'T' 
				AND IASFINHEAD.CLIENT = IASFINITEM.CLIENT 
				AND IASFINHEAD.COMPANY = IASFINITEM.COMPANY 
				AND IASFINHEAD.ACCSTD = IASFINITEM.ACCSTD 
				AND IASFINHEAD.FINDOCTYPE = IASFINITEM.FINDOCTYPE 
				AND IASFINHEAD.FINDOCNUM = IASFINITEM.FINDOCNUM 
			GROUPBY IASFINITEM.CURRENCY, IASFINITEM.CUSTOMER, IASACCOUNTX.STEXT , IASFINITEM.FINDOCTYPE 
			ORDERBY HBALANCE DESC 
			INTO XX;


		IF SELECTED THEN
			COPY TABLE XX INTO MAILTBL;
			MLTO = TMPUSERS.GETUSERMAILBYGRPINFO('DNM');
			MLCC='';
			HTMLMSG = DT +' - '+DT2+' Tarihli Vadesi Gelen Müşteri Ödemeleri';
			HTMLSUB =  DT +' - '+DT2+' Tarihli Vadesi Gelen Müşteri Ödemeleri';
			HTMLMSG = XXXUTILREC.MAILHTMLGENERAL('02',SYS_LANGU,'BAS',1001,'BAS',1002,'BAS',1003,HTMLSUB,HTMLMSG,'MAILTBL','Belge Tipi, Müşteri No., Müşteri Adı, Toplam Miktar, Açık Miktar, Kur','FINDOCTYPE,CUSTOMER,ATEXT,HPOSTAMNT,HBALANCE,CURRENCY',',');
			XXXUTILREC.XXXSENDMAIL(HTMLMSG,HTMLSUB,MLTO,MLCC,'') ;
		ENDIF;

	ENDIF;

ENDIF;

TRACEOFF;
 /*BATILGAN 19.12.2022 MÜŞTERİLERDEN ALINACAK ÖDEMELERİN E-MAIL GÖNDERİMİ BİTİR*/
