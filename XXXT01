--XXXT01
-- BEFORE --
OBJECT: 
 STRING COMP,
 STRING PLANT,
 STRING CLIENT,
 STRING SALDTYPE,
 STRING SALDNUM,
 STRING CREATEDBY,
 STRING CREATEDAT,
 STRING MATERIAL,
 TABLE TPMWVANO,
 TABLE WVANOGUNCELLE,
 DATE EDATES,
 DATE EDATEE;

SELECT WVAID, SALDOCTYPE, SALDOCNUM, MATERIAL,
	 WVACODE, STEXT, LTEXT, CONFSTATUS,
	 CONFBY, CONFDATE, CREATEDBY, CREATEDAT,
	 '' AS CHAGEDBY, '' AS CHAGEDAT, ISWEBSITE, '' AS WEBLNKGO,
	 '' AS WEBLNK 
	FROM WVANOGUNCELLE 
	WHERE 1 = 2 
	INTO TPMWVANO;

SETCOLFORMAT TPMWVANO_CONFSTATUS TO 'CMB0:Bekliyor|1:Onaylandı|2:Reddedildi|3:İnceleniyor';
SETCOLFORMAT TPMWVANO_STEXT TO 'CMB0:WVA NUMARASI|1:XXXXXX|2:OEM NUMARASI';
/* USER BASED DEVELOPMENT */
IF SYS_USER != '***' 
		&& SYS_USER != '***' THEN
	SET UPDATE TO HIDE;
	SET CONFSTAT TO HIDE;
	SET CONFSTAT2 TO HIDE;
	SET CONFSTAT3 TO HIDE;
ENDIF;

SCISWEBSITE = 2;

-- SEARCH -- 
OBJECT: 
 STRING SELWHERE;

SYSADDITIONALCRITERIA='';

SWITCH SCCONF 
CASE 0:
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND CONFSTATUS LIKE ' + TOCHAR(39)+TOCHAR(37)+TOCHAR(39);
CASE 1:
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND CONFSTATUS IN (' + TOCHAR(39)+'0'+TOCHAR(39)+ ',' +TOCHAR(39)+'3'+TOCHAR(39) + ')' ;
CASE 2:
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND CONFSTATUS LIKE ' + TOCHAR(39)+'1'+TOCHAR(39);
CASE 3:
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND CONFSTATUS LIKE ' + TOCHAR(39)+'2'+TOCHAR(39);
ENDSWITCH;


IF SCISWEBSITE == 0 THEN
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND ISWEBSITE = ' + TOCHAR(39)+'1'+TOCHAR(39);
ENDIF;


IF SCISWEBSITE == 1 THEN
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND ISWEBSITE = ' + TOCHAR(39)+'0'+TOCHAR(39);
ENDIF;


IF SCISWEBSITE == 2 THEN
	SYSADDITIONALCRITERIA=SYSADDITIONALCRITERIA+' AND ISWEBSITE LIKE ' + TOCHAR(39)+'%'+TOCHAR(39);
ENDIF;

SELECT WVANOGUNCELLE.* ,'' AS WEBLNKGO 
	FROM WVANOGUNCELLE 
	WHERE CLIENT = SYS_CLIENT 
		AND COMPANY LIKE CP(SCOMP) 
		AND PLANT LIKE CP(SPLAN) 
		AND WVAID LIKE CP(SCREGISTER) 
		AND MATERIAL LIKE CP(SCMATERIAL) 
		AND SALDOCNUM LIKE CP(SCSALDOCNUM) 
		AND SALDOCTYPE LIKE CP(SCSALDOCTYPE) 
		AND LTEXT LIKE CP(SCLTEXT) 
		AND WVACODE LIKE CP(SCWVAID) 
		AND CREATEDAT>=EDATE @SYSADDITIONALCRITERIA 
		AND ISDELETE = SCISDELETE 
	INTO TPMWVANO;
	
	
-- CONFSTAT3 --

LOOP AT TPMWVANO CRITERIA COLUMNS SELECTED VALUES 1 
BEGIN
	UPDATE WVANOGUNCELLE 
		SET CONFSTATUS = 2 
		WHERE CLIENT=SYS_CLIENT 
			AND COMPANY = TPMWVANO_COMPANY 
			AND PLANT=TPMWVANO_PLANT 
			AND WVAID=TPMWVANO_WVAID 
			AND MATERIAL=TPMWVANO_MATERIAL;
THIS.SEARCH();
ENDLOOP;

-- CONFSTAT2 -- 

LOOP AT TPMWVANO CRITERIA COLUMNS SELECTED VALUES 1 
BEGIN
	UPDATE WVANOGUNCELLE 
		SET CONFSTATUS = 1
		WHERE CLIENT=SYS_CLIENT 
			AND COMPANY = TPMWVANO_COMPANY 
			AND PLANT=TPMWVANO_PLANT 
			AND WVAID=TPMWVANO_WVAID 
			AND MATERIAL=TPMWVANO_MATERIAL;
THIS.SEARCH();
ENDLOOP;

-- CONFSTAT -- 

LOOP AT TPMWVANO CRITERIA COLUMNS SELECTED VALUES 1 
BEGIN
	UPDATE WVANOGUNCELLE 
		SET CONFSTATUS = 3 
		WHERE CLIENT=SYS_CLIENT 
			AND COMPANY = TPMWVANO_COMPANY 
			AND PLANT=TPMWVANO_PLANT 
			AND WVAID=TPMWVANO_WVAID 
			AND MATERIAL=TPMWVANO_MATERIAL;
THIS.SEARCH();
ENDLOOP;

-- SAVE --

OBJECT: 
 STRING UPSET,
 STRING MSG1,
 STRING MSG2,
 NUMRANGE NRANGE,
 STRING MSG3;

TPMWVANO_CLIENT=SYS_CLIENT;
TPMWVANO_COMPANY='02';
TPMWVANO_PLANT='01';
MSG1 = 'Değişiklikler Başarıyla Kaydedildi.';
MSG2 = 'Değişiklikler Kaydedilemedi.';
OBJECT: 
 INTEGER INDBTRAN,
 INTEGER DEL;

INDBTRAN = SYS_INDBTRANSACTION;
DEL = 0;

LOOP AT TPMWVANO CRITERIA COLUMNS UPDATED,DELETED VALUES 1,0 
BEGIN

	IF INDBTRAN == 0 THEN
		BEGINTRAN;
	ENDIF;

	UPDATE WVANOGUNCELLE 
		SET WVANOGUNCELLE.SALDOCTYPE = TPMWVANO_SALDOCTYPE, WVANOGUNCELLE.SALDOCNUM = TPMWVANO_SALDOCNUM, WVANOGUNCELLE.CONFSTATUS = TPMWVANO_CONFSTATUS, WVANOGUNCELLE.CONFBY = TPMWVANO_CONFBY, WVANOGUNCELLE.CONFDATE = TPMWVANO_CONFDATE, WVANOGUNCELLE.WVACODE = TPMWVANO_WVACODE, WVANOGUNCELLE.LTEXT = TPMWVANO_LTEXT, WVANOGUNCELLE.SITEENTRY = TPMWVANO_SITEENTRY, CHANGEDAT = SYS_CURRENTDATE, CHANGEDBY = SYS_USER, ISDELETE = DEL, ISWEBSITE = TPMWVANO_ISWEBSITE 
		WHERE CLIENT=SYS_CLIENT 
			AND COMPANY = TPMWVANO_COMPANY 
			AND PLANT=TPMWVANO_PLANT 
			AND WVAID=TPMWVANO_WVAID 
			AND MATERIAL=TPMWVANO_MATERIAL;


	IF SYS_STATUS THEN
		MSG3='Güncelleme Yapılamadı! Hatalı Satır Numarası= '+TPMWVANO_ACTIVEROW;
		MESSAGE XXX I1 WITH MSG3;
		ROLLBACKTRAN;
		RETURN;
	ELSE
		MSG3='Güncelleme İşlemi Gerçekleştirildi!';
		MESSAGE XXX I1 WITH MSG3;
		COMMITTRAN;
	ENDIF;

ENDLOOP;

INDBTRAN = SYS_INDBTRANSACTION;

LOOP AT TPMWVANO CRITERIA COLUMNS DELETED VALUES 1,0 
BEGIN

	IF INDBTRAN == 0 THEN
		BEGINTRAN;
	ENDIF;

	UPDATE WVANOGUNCELLE 
		SET WVANOGUNCELLE.ISDELETE = 1 
		WHERE CLIENT=SYS_CLIENT 
			AND COMPANY = TPMWVANO_COMPANY 
			AND PLANT=TPMWVANO_PLANT 
			AND WVAID=TPMWVANO_WVAID 
			AND MATERIAL=TPMWVANO_MATERIAL;


	IF SYS_STATUS THEN
		ROLLBACKTRAN;
		RETURN;
	ELSE
		MSG3='Silme İşlemi Gerçekleştirildi!';
		MESSAGE XXX I1 WITH MSG3;
		COMMITTRAN;
	ENDIF;

ENDLOOP;

THIS.SEARCH();


-- XXXT01D002 --

-- BEFORE --

OBJECT: 
 STRING COMP,
 STRING PLANT,
 STRING CLIENT,
 STRING SALDTYPE,
 STRING SALDNUM,
 STRING CREATEDBY,
 STRING CREATEDAT,
 STRING MATERIAL,
 TABLE TPMWVANO,
 TABLE WVANOGUNCELLE,
 DATE EDATES,
 DATE EDATEE;

SCOMP = YOUR_COMPANY_CODE;
SPLAN = YOUR_PLANT_CODE;
SELECT WVAID, SALDOCTYPE, SALDOCNUM, MATERIAL,
	 WVACODE, STEXT, LTEXT, CONFSTATUS,
	 CONFBY, CONFDATE, CREATEDBY, CREATEDAT,
	 '' AS CHAGEDBY, '' AS CHAGEDAT, ISWEBSITE, '' AS WEBLNKGO,
	 '' AS WEBLNK 
	FROM WVANOGUNCELLE 
	WHERE 1 = 2 
	INTO TPMWVANOA;

SETCOLFORMAT TPMWVANOA_CONFSTATUS TO 'CMB0:Bekliyor|1:Onaylandı|2:Reddedildi|3:İnceleniyor';
SETCOLFORMAT TPMWVANOA_STEXT TO 'CMB0:WVA NUMARASI|1:XXXXXXX|2:OEM NUMARASI';

TPMWVANOA_CONFSTATUS = 0;

-- SAVE -- 

OBJECT: 
 STRING UPSET,
 STRING MSG1,
 STRING MSG2,
 NUMRANGE NRANGE,
 STRING MSG3;

OBJECT: 
 INTEGER INDBTRAN;

INDBTRAN = SYS_INDBTRANSACTION;

LOOP AT TPMWVANOA CRITERIA COLUMNS INSERTED VALUES 1,0 
BEGIN
	SELECT * 
		FROM WVANOGUNCELLE 
		WHERE 1=2;

	APPEND ROW TO WVANOGUNCELLE;
	MOVE-CORRESPONDING TPMWVANOA TO WVANOGUNCELLE;
	WVANOGUNCELLE_WVAID=NRANGE.NEWNUMBERS('02', 'WVAGIRIS');
	MOVE SYS_USER TO WVANOGUNCELLE_CREATEDBY;
	MOVE SYS_USER TO WVANOGUNCELLE_CHANGEDBY;
	MOVE SYS_CURRENTDATE TO WVANOGUNCELLE_CREATEDAT;
	MOVE SYS_USER TO WVANOGUNCELLE_CREATEDBY;
	MOVE SYS_CLIENT TO WVANOGUNCELLE_CLIENT;
	MOVE SCOMP TO WVANOGUNCELLE_COMPANY;
	MOVE SPLAN TO WVANOGUNCELLE_PLANT;
    
    IF WVANOGUNCELLE_WVACODE == '' || WVANOGUNCELLE_STEXT == '' THEN
        MSG3 = 'ZORUNLU ALANLAR BOŞ BIRAKILAMAZ! (MALZEME, EKLENECEK KOD, KOD TİPİ)';
        		MESSAGE XXX E1 WITH MSG3;
    RETURN;
    ENDIF;
    
	IF INDBTRAN == 0 THEN
		BEGINTRAN;
	ENDIF;

	INSERT INTO WVANOGUNCELLE;

	IF SYS_STATUS THEN
		MSG3='Yeni kayıt oluşturulamadı Yapılamadı! Hatalı Satır Numarası= '+TPMWVANOA_ACTIVEROW;
		MESSAGE XXX I1 WITH MSG3;
		ROLLBACKTRAN;
		RETURN;
	ELSE
		MSG3='Kayıt tamamlandı.';
		MESSAGE XXX I1 WITH MSG3;
		COMMITTRAN;
	ENDIF;

ENDLOOP;

SHUTDOWN;
THIS.SEARCH();
